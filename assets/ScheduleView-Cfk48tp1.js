import{j as e,P as N,u as Z,C as V}from"./index-BqPi6Scg.js";import{a as o}from"./vendor-CMvHcHbC.js";import{a as ie,u as oe}from"./redux-IAqEd8mO.js";import{c as O,a as v,b as X}from"./index.esm-CgghJxql.js";import{C as ee,d as ce,e as de,f as me,h as k,i as Y,j as ue,k as he,l as pe,m as fe,n as xe,o as je,p as _e,q as G,u as ye,r as ge}from"./DefaultLayout-DhHfHE_z.js";import{u as K}from"./useLocale-C1tm0iYC.js";import{c as W,d as J,a as ve,b as L}from"./CForm-CHhLrB3s.js";import{c as Ce}from"./cil-clock-0brlqJOZ.js";import{c as Ne}from"./cil-user-Ddrdy7PS.js";import{a as q,b as P,c as C}from"./CRow-D_28WzSY.js";import{c as be}from"./cil-options-sHCm5Gxk.js";import{C as Se}from"./CCardHeader-vqvVWZ-H.js";import"./navPaths-CZBFaHdh.js";const se=({appointment:s,onClick:j,hideClientPII:h})=>{var n;const{t:r}=K(),E=l=>({scheduled:"info",confirmed:"success",in_progress:"warning",completed:"secondary",cancelled:"danger",no_show:"dark"})[l]||"primary",c=l=>l.substring(0,5),D=()=>{var l,_,p;return h?((l=s.clients)==null?void 0:l.first_name)||r("schedule.card.client"):`${((_=s.clients)==null?void 0:_.first_name)||""} ${((p=s.clients)==null?void 0:p.last_name)||""}`.trim()};return e.jsx(W,{className:"mb-2 cursor-pointer hover-shadow",onClick:j,style:{cursor:"pointer"},children:e.jsx(J,{className:"py-2 px-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2 mb-1",children:[e.jsx(O,{icon:Ce,size:"sm"}),e.jsxs("strong",{children:[c(s.start_time)," - ",c(s.end_time)]}),e.jsx(ee,{color:E(s.status),children:s.status})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx("strong",{className:"text-primary",children:(n=s.services)==null?void 0:n.name}),e.jsxs("span",{className:"text-muted ms-2",children:["(",s.duration_minutes," ",r("schedule.card.min"),")"]})]}),e.jsxs("div",{className:"d-flex align-items-center gap-3 text-muted small",children:[e.jsxs("div",{className:"d-flex align-items-center gap-1",children:[e.jsx(O,{icon:Ne,size:"sm"}),e.jsx("span",{children:D()})]}),s.employees&&e.jsxs("div",{children:[r("schedule.card.staff")," ",s.employees.first_name," ",s.employees.last_name]}),e.jsxs("div",{className:"ms-auto",children:[s.total_amount," PLN"]})]}),s.client_notes&&e.jsxs("div",{className:"mt-1 small text-muted",children:[r("schedule.card.note")," ",s.client_notes]})]}),e.jsx(q,{color:"light",size:"sm",onClick:l=>{l.stopPropagation(),j()},children:e.jsx(O,{icon:be})})]})})})};se.propTypes={appointment:N.object.isRequired,onClick:N.func.isRequired,hideClientPII:N.bool};const te=({appointment:s,onSubmit:j,onCancel:h,loading:r,error:E})=>{const{business:c,user:D}=Z(),{t:n}=K(),[l,_]=o.useState({client_id:"",employee_id:"",service_id:"",appointment_date:"",start_time:"",client_notes:"",internal_notes:"",status:"scheduled"}),[p,b]=o.useState([]),[T,B]=o.useState([]),[S,U]=o.useState([]),[d,y]=o.useState(null),[I,A]=o.useState(!0);o.useEffect(()=>{M()},[c==null?void 0:c.id]),o.useEffect(()=>{var t;s&&_({client_id:s.client_id||"",employee_id:s.employee_id||"",service_id:s.service_id||"",appointment_date:s.appointment_date||"",start_time:((t=s.start_time)==null?void 0:t.substring(0,5))||"",client_notes:s.client_notes||"",internal_notes:s.internal_notes||"",status:s.status||"scheduled"})},[s]),o.useEffect(()=>{if(l.service_id&&S.length>0){const t=S.find(m=>m.id===l.service_id);y(t)}},[l.service_id,S]);const M=async()=>{if(!(c!=null&&c.id))return;A(!0);const[t,m,x]=await Promise.all([ce(c.id),de(c.id),me(c.id)]);t.data&&b(t.data),m.data&&B(m.data),x.data&&U(x.data),A(!1)},w=(t,m)=>{if(!t||!m)return"";const[x,F]=t.split(":").map(Number),R=x*60+F+m,z=Math.floor(R/60),$=R%60;return`${String(z).padStart(2,"0")}:${String($).padStart(2,"0")}:00`},f=t=>{const{name:m,value:x}=t.target;_(F=>({...F,[m]:x}))},g=t=>{if(t.preventDefault(),!d){alert(n("schedule.form.selectServiceError"));return}const m=w(l.start_time,d.duration_minutes),x={...l,business_id:c.id,start_time:`${l.start_time}:00`,end_time:m,duration_minutes:d.duration_minutes,service_price:d.price,total_amount:d.price,currency:"PLN",booking_reference:s?s.booking_reference:"REF"+Math.random().toString(36).substr(2,6).toUpperCase()};j(x)};return I?e.jsx("div",{className:"text-center py-4",children:e.jsx(V,{color:"primary"})}):e.jsxs(ve,{onSubmit:g,children:[E&&e.jsx(L,{color:"danger",className:"mb-3",children:E}),e.jsxs(P,{className:"mb-3",children:[e.jsxs(C,{md:6,children:[e.jsxs(v,{htmlFor:"client_id",children:[n("schedule.form.client")," *"]}),e.jsxs(k,{id:"client_id",name:"client_id",value:l.client_id,onChange:f,required:!0,disabled:r,children:[e.jsx("option",{value:"",children:n("schedule.form.selectClient")}),p.map(t=>e.jsxs("option",{value:t.id,children:[t.first_name," ",t.last_name]},t.id))]})]}),e.jsxs(C,{md:6,children:[e.jsxs(v,{htmlFor:"service_id",children:[n("schedule.form.service")," *"]}),e.jsxs(k,{id:"service_id",name:"service_id",value:l.service_id,onChange:f,required:!0,disabled:r,children:[e.jsx("option",{value:"",children:n("schedule.form.selectService")}),S.map(t=>e.jsxs("option",{value:t.id,children:[t.name," - ",t.price," PLN (",t.duration_minutes," ",n("common.labels.min"),")"]},t.id))]})]})]}),e.jsxs(P,{className:"mb-3",children:[e.jsxs(C,{md:6,children:[e.jsx(v,{htmlFor:"employee_id",children:n("schedule.form.staffMember")}),e.jsxs(k,{id:"employee_id",name:"employee_id",value:l.employee_id,onChange:f,disabled:r,children:[e.jsx("option",{value:"",children:n("schedule.form.anyAvailable")}),T.filter(t=>t.status==="active").map(t=>e.jsxs("option",{value:t.id,children:[t.first_name," ",t.last_name]},t.id))]})]}),e.jsxs(C,{md:6,children:[e.jsx(v,{htmlFor:"status",children:n("schedule.form.status")}),e.jsxs(k,{id:"status",name:"status",value:l.status,onChange:f,disabled:r,children:[e.jsx("option",{value:"scheduled",children:n("schedule.form.statusScheduled")}),e.jsx("option",{value:"confirmed",children:n("schedule.form.statusConfirmed")}),e.jsx("option",{value:"in_progress",children:n("schedule.form.statusInProgress")}),e.jsx("option",{value:"completed",children:n("schedule.form.statusCompleted")}),e.jsx("option",{value:"cancelled",children:n("schedule.form.statusCancelled")}),e.jsx("option",{value:"no_show",children:n("schedule.form.statusNoShow")})]})]})]}),e.jsxs(P,{className:"mb-3",children:[e.jsxs(C,{md:6,children:[e.jsxs(v,{htmlFor:"appointment_date",children:[n("schedule.form.date")," *"]}),e.jsx(X,{id:"appointment_date",name:"appointment_date",type:"date",value:l.appointment_date,onChange:f,required:!0,disabled:r})]}),e.jsxs(C,{md:6,children:[e.jsxs(v,{htmlFor:"start_time",children:[n("schedule.form.startTime")," *"]}),e.jsx(X,{id:"start_time",name:"start_time",type:"time",value:l.start_time,onChange:f,required:!0,disabled:r})]})]}),d&&e.jsxs(L,{color:"info",className:"mb-3",children:[n("schedule.form.duration")," ",d.duration_minutes," ",n("common.labels.minutes")," |",n("schedule.form.price")," ",d.price," PLN"]}),e.jsx(P,{className:"mb-3",children:e.jsxs(C,{children:[e.jsx(v,{htmlFor:"client_notes",children:n("schedule.form.clientNotes")}),e.jsx(Y,{id:"client_notes",name:"client_notes",rows:"2",value:l.client_notes,onChange:f,disabled:r})]})}),e.jsx(P,{className:"mb-3",children:e.jsxs(C,{children:[e.jsx(v,{htmlFor:"internal_notes",children:n("schedule.form.internalNotes")}),e.jsx(Y,{id:"internal_notes",name:"internal_notes",rows:"2",value:l.internal_notes,onChange:f,disabled:r})]})}),e.jsxs("div",{className:"d-flex justify-content-end gap-2",children:[e.jsx(q,{color:"secondary",onClick:h,disabled:r,children:n("schedule.form.cancel")}),e.jsx(q,{color:"primary",type:"submit",disabled:r,children:r?e.jsxs(e.Fragment,{children:[e.jsx(V,{size:"sm",className:"me-2"}),n("schedule.form.saving")]}):n(s?"schedule.form.updateAppointment":"schedule.form.createAppointment")})]})]})};te.propTypes={appointment:N.object,onSubmit:N.func.isRequired,onCancel:N.func.isRequired,loading:N.bool,error:N.string};const qe=()=>{const s=ie(),{business:j,user:h}=Z(),{t:r,locale:E}=K(),{appointments:c,loading:D,error:n,filters:l}=oe(a=>a.appointments),[_,p]=o.useState(!1),[b,T]=o.useState(null),[B,S]=o.useState(!1),[U,d]=o.useState(null),[y,I]=o.useState(null),[A,M]=o.useState(null),[w,f]=o.useState({}),g=j==null?void 0:j.id;o.useEffect(()=>{g&&h&&t()},[g,h]),o.useEffect(()=>{g&&y!==null&&m()},[g,l,y,A]),o.useEffect(()=>{c&&x()},[c]);const t=async()=>{var i;const a=(i=h==null?void 0:h.user_metadata)==null?void 0:i.role;if(a==="business_owner"||a==="manager")I("admin"),M(null);else{I("employee");const{data:u}=await ue(h.id);u&&M(u.id)}},m=async()=>{console.log("[todo] loading appointments"),s({type:"APPOINTMENTS_LOADING"});const a={...l};y==="employee"&&A&&(a.employeeId=A);const{data:i,error:u}=await he(g,a);console.log("[todo getAppointments] response",{data:i,error:u}),u?(console.log("[todo] Error loading appointments"),s({type:"APPOINTMENTS_ERROR",payload:u})):(console.log("[todo] Appointments loaded successfully"),s({type:"APPOINTMENTS_SUCCESS",payload:i||[]}))},x=()=>{const a={};c.forEach(i=>{const u=i.appointment_date;a[u]||(a[u]=[]),a[u].push(i)}),f(a)},F=()=>{T(null),d(null),p(!0)},R=a=>{T(a),d(null),p(!0)},z=async a=>{S(!0),d(null);let i;b?i=await ye(b.id,a):i=await ge(a),S(!1),i.error?d(i.error):(s(b?{type:"UPDATE_APPOINTMENT",payload:i.data}:{type:"ADD_APPOINTMENT",payload:i.data}),p(!1))},$=a=>{const i=new Date(a),u=new Date,H=new Date(u);H.setDate(H.getDate()+1);const Q=G(i),ae=G(u),le=G(H);return Q===ae?r("schedule.today"):Q===le?r("schedule.tomorrow"):i.toLocaleDateString(E,{weekday:"long",year:"numeric",month:"long",day:"numeric"})},ne=a=>y==="admin"||y==="employee"&&a.employee_id===A,re=y==="employee";return g?e.jsxs(e.Fragment,{children:[e.jsxs(W,{className:"mb-4",children:[e.jsxs(Se,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:r("schedule.title")}),e.jsxs(q,{color:"primary",onClick:F,children:[e.jsx(O,{icon:pe,className:"me-2"}),r("schedule.newAppointment")]})]}),e.jsxs(J,{children:[n&&e.jsx(L,{color:"danger",className:"mb-3",children:n}),D?e.jsx("div",{className:"text-center py-5",children:e.jsx(V,{color:"primary"})}):Object.keys(w).length===0?e.jsx("div",{className:"text-center py-5 text-muted",children:r("schedule.emptyState")}):e.jsx("div",{children:Object.keys(w).sort().map(a=>e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2 mb-3",children:[e.jsx("h5",{className:"mb-0",children:$(a)}),e.jsxs(ee,{color:"primary",className:"ms-2",children:[w[a].length," ",w[a].length!==1?r("schedule.appointments"):r("schedule.appointment")]})]}),w[a].map(i=>e.jsx(se,{appointment:i,onClick:()=>ne(i)&&R(i),hideClientPII:re},i.id))]},a))})]})]}),e.jsxs(fe,{visible:_,onClose:()=>p(!1),size:"lg",children:[e.jsx(xe,{children:e.jsx(je,{children:r(b?"schedule.editAppointment":"schedule.newAppointment")})}),e.jsx(_e,{children:e.jsx(te,{appointment:b,onSubmit:z,onCancel:()=>p(!1),loading:B,error:U})})]})]}):e.jsx(W,{children:e.jsx(J,{children:e.jsx(L,{color:"warning",children:r("schedule.noBusinessWarning")})})})};export{qe as default};
