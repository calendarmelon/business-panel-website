import{j as e,P as C,u as Q,C as G}from"./index-DMjyWb87.js";import{a}from"./vendor-39lPmIfa.js";import{a as ne,u as ie}from"./redux-B4nc4lEw.js";import{c as O,a as g,b as V}from"./index.esm-Li650mXS.js";import{C as W,g as re,a as ae,b as le,c as M,d as K,e as oe,f as ce,h as de,i as me,j as ue,k as pe,l as he,u as xe,m as fe}from"./DefaultLayout-D0SvWDL6.js";import{d as H,e as Z,f as je,b as _e,c as R}from"./useLocale-D5KkehiU.js";import{a as k,b as P,c as y}from"./CRow-D_VJqXdr.js";import{c as ge}from"./cil-options-sHCm5Gxk.js";import{C as ye}from"./CCardHeader-B4dk8NaO.js";var Ce=["512 512","<polygon fill='var(--ci-primary-color, currentColor)' points='271.514 95.5 239.514 95.5 239.514 273.611 355.127 328.559 368.864 299.657 271.514 253.389 271.514 95.5' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M256,16C123.452,16,16,123.452,16,256S123.452,496,256,496,496,388.548,496,256,388.548,16,256,16Zm0,448C141.125,464,48,370.875,48,256S141.125,48,256,48s208,93.125,208,208S370.875,464,256,464Z' class='ci-primary'/>"];const X=({appointment:s,onClick:j,hideClientPII:h})=>{var v;const l=i=>({scheduled:"info",confirmed:"success",in_progress:"warning",completed:"secondary",cancelled:"danger",no_show:"dark"})[i]||"primary",_=i=>i.substring(0,5),o=()=>{var i,p,x;return h?((i=s.clients)==null?void 0:i.first_name)||"Client":`${((p=s.clients)==null?void 0:p.first_name)||""} ${((x=s.clients)==null?void 0:x.last_name)||""}`.trim()};return e.jsx(H,{className:"mb-2 cursor-pointer hover-shadow",onClick:j,style:{cursor:"pointer"},children:e.jsx(Z,{className:"py-2 px-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2 mb-1",children:[e.jsx(O,{icon:Ce,size:"sm"}),e.jsxs("strong",{children:[_(s.start_time)," - ",_(s.end_time)]}),e.jsx(W,{color:l(s.status),children:s.status})]}),e.jsxs("div",{className:"mb-1",children:[e.jsx("strong",{className:"text-primary",children:(v=s.services)==null?void 0:v.name}),e.jsxs("span",{className:"text-muted ms-2",children:["(",s.duration_minutes," min)"]})]}),e.jsxs("div",{className:"d-flex align-items-center gap-3 text-muted small",children:[e.jsxs("div",{className:"d-flex align-items-center gap-1",children:[e.jsx(O,{icon:je,size:"sm"}),e.jsx("span",{children:o()})]}),s.employees&&e.jsxs("div",{children:["Staff: ",s.employees.first_name," ",s.employees.last_name]}),e.jsxs("div",{className:"ms-auto",children:[s.total_amount," PLN"]})]}),s.client_notes&&e.jsxs("div",{className:"mt-1 small text-muted",children:["Note: ",s.client_notes]})]}),e.jsx(k,{color:"light",size:"sm",onClick:i=>{i.stopPropagation(),j()},children:e.jsx(O,{icon:ge})})]})})})};X.propTypes={appointment:C.object.isRequired,onClick:C.func.isRequired,hideClientPII:C.bool};const Y=({appointment:s,onSubmit:j,onCancel:h,loading:l,error:_})=>{const{business:o,user:v}=Q(),[i,p]=a.useState({client_id:"",employee_id:"",service_id:"",appointment_date:"",start_time:"",client_notes:"",internal_notes:"",status:"scheduled"}),[x,T]=a.useState([]),[L,D]=a.useState([]),[N,b]=a.useState([]),[c,F]=a.useState(null),[A,w]=a.useState(!0);a.useEffect(()=>{S()},[o==null?void 0:o.id]),a.useEffect(()=>{var t;s&&p({client_id:s.client_id||"",employee_id:s.employee_id||"",service_id:s.service_id||"",appointment_date:s.appointment_date||"",start_time:((t=s.start_time)==null?void 0:t.substring(0,5))||"",client_notes:s.client_notes||"",internal_notes:s.internal_notes||"",status:s.status||"scheduled"})},[s]),a.useEffect(()=>{if(i.service_id&&N.length>0){const t=N.find(m=>m.id===i.service_id);F(t)}},[i.service_id,N]);const S=async()=>{if(!(o!=null&&o.id))return;w(!0);const[t,m,f]=await Promise.all([re(o.id),ae(o.id),le(o.id)]);t.data&&T(t.data),m.data&&D(m.data),f.data&&b(f.data),w(!1)},q=(t,m)=>{if(!t||!m)return"";const[f,E]=t.split(":").map(Number),I=f*60+E+m,B=Math.floor(I/60),z=I%60;return`${String(B).padStart(2,"0")}:${String(z).padStart(2,"0")}:00`},d=t=>{const{name:m,value:f}=t.target;p(E=>({...E,[m]:f}))},U=t=>{if(t.preventDefault(),!c){alert("Please select a service");return}const m=q(i.start_time,c.duration_minutes),f={...i,business_id:o.id,start_time:`${i.start_time}:00`,end_time:m,duration_minutes:c.duration_minutes,service_price:c.price,total_amount:c.price,currency:"PLN",booking_reference:s?s.booking_reference:"REF"+Math.random().toString(36).substr(2,6).toUpperCase()};j(f)};return A?e.jsx("div",{className:"text-center py-4",children:e.jsx(G,{color:"primary"})}):e.jsxs(_e,{onSubmit:U,children:[_&&e.jsx(R,{color:"danger",className:"mb-3",children:_}),e.jsxs(P,{className:"mb-3",children:[e.jsxs(y,{md:6,children:[e.jsx(g,{htmlFor:"client_id",children:"Client *"}),e.jsxs(M,{id:"client_id",name:"client_id",value:i.client_id,onChange:d,required:!0,disabled:l,children:[e.jsx("option",{value:"",children:"Select Client"}),x.map(t=>e.jsxs("option",{value:t.id,children:[t.first_name," ",t.last_name]},t.id))]})]}),e.jsxs(y,{md:6,children:[e.jsx(g,{htmlFor:"service_id",children:"Service *"}),e.jsxs(M,{id:"service_id",name:"service_id",value:i.service_id,onChange:d,required:!0,disabled:l,children:[e.jsx("option",{value:"",children:"Select Service"}),N.map(t=>e.jsxs("option",{value:t.id,children:[t.name," - ",t.price," PLN (",t.duration_minutes," min)"]},t.id))]})]})]}),e.jsxs(P,{className:"mb-3",children:[e.jsxs(y,{md:6,children:[e.jsx(g,{htmlFor:"employee_id",children:"Staff Member"}),e.jsxs(M,{id:"employee_id",name:"employee_id",value:i.employee_id,onChange:d,disabled:l,children:[e.jsx("option",{value:"",children:"Any Available"}),L.filter(t=>t.status==="active").map(t=>e.jsxs("option",{value:t.id,children:[t.first_name," ",t.last_name]},t.id))]})]}),e.jsxs(y,{md:6,children:[e.jsx(g,{htmlFor:"status",children:"Status"}),e.jsxs(M,{id:"status",name:"status",value:i.status,onChange:d,disabled:l,children:[e.jsx("option",{value:"scheduled",children:"Scheduled"}),e.jsx("option",{value:"confirmed",children:"Confirmed"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"cancelled",children:"Cancelled"}),e.jsx("option",{value:"no_show",children:"No Show"})]})]})]}),e.jsxs(P,{className:"mb-3",children:[e.jsxs(y,{md:6,children:[e.jsx(g,{htmlFor:"appointment_date",children:"Date *"}),e.jsx(V,{id:"appointment_date",name:"appointment_date",type:"date",value:i.appointment_date,onChange:d,required:!0,disabled:l})]}),e.jsxs(y,{md:6,children:[e.jsx(g,{htmlFor:"start_time",children:"Start Time *"}),e.jsx(V,{id:"start_time",name:"start_time",type:"time",value:i.start_time,onChange:d,required:!0,disabled:l})]})]}),c&&e.jsxs(R,{color:"info",className:"mb-3",children:["Duration: ",c.duration_minutes," minutes | Price: ",c.price," PLN"]}),e.jsx(P,{className:"mb-3",children:e.jsxs(y,{children:[e.jsx(g,{htmlFor:"client_notes",children:"Client Notes"}),e.jsx(K,{id:"client_notes",name:"client_notes",rows:"2",value:i.client_notes,onChange:d,disabled:l})]})}),e.jsx(P,{className:"mb-3",children:e.jsxs(y,{children:[e.jsx(g,{htmlFor:"internal_notes",children:"Internal Notes"}),e.jsx(K,{id:"internal_notes",name:"internal_notes",rows:"2",value:i.internal_notes,onChange:d,disabled:l})]})}),e.jsxs("div",{className:"d-flex justify-content-end gap-2",children:[e.jsx(k,{color:"secondary",onClick:h,disabled:l,children:"Cancel"}),e.jsx(k,{color:"primary",type:"submit",disabled:l,children:l?e.jsxs(e.Fragment,{children:[e.jsx(G,{size:"sm",className:"me-2"}),"Saving..."]}):s?"Update Appointment":"Create Appointment"})]})]})};Y.propTypes={appointment:C.object,onSubmit:C.func.isRequired,onCancel:C.func.isRequired,loading:C.bool,error:C.string};const De=()=>{const s=ne(),{business:j,user:h}=Q(),{appointments:l,loading:_,error:o,filters:v}=ie(n=>n.appointments),[i,p]=a.useState(!1),[x,T]=a.useState(null),[L,D]=a.useState(!1),[N,b]=a.useState(null),[c,F]=a.useState(null),[A,w]=a.useState(null),[S,q]=a.useState({}),d=j==null?void 0:j.id;a.useEffect(()=>{d&&h&&U()},[d,h]),a.useEffect(()=>{d&&c!==null&&t()},[d,v,c,A]),a.useEffect(()=>{l&&m()},[l]);const U=async()=>{var r;const n=(r=h==null?void 0:h.user_metadata)==null?void 0:r.role;if(n==="business_owner"||n==="manager")F("admin"),w(null);else{F("employee");const{data:u}=await oe(h.id);u&&w(u.id)}},t=async()=>{console.log("[todo] loading appointments"),s({type:"APPOINTMENTS_LOADING"});const n={...v};c==="employee"&&A&&(n.employeeId=A);const{data:r,error:u}=await ce(d,n);console.log("[todo getAppointments] response",{data:r,error:u}),u?(console.log("[todo] Error loading appointments"),s({type:"APPOINTMENTS_ERROR",payload:u})):(console.log("[todo] Appointments loaded successfully"),s({type:"APPOINTMENTS_SUCCESS",payload:r||[]}))},m=()=>{const n={};l.forEach(r=>{const u=r.appointment_date;n[u]||(n[u]=[]),n[u].push(r)}),q(n)},f=()=>{T(null),b(null),p(!0)},E=n=>{T(n),b(null),p(!0)},I=async n=>{D(!0),b(null);let r;x?r=await xe(x.id,n):r=await fe(n),D(!1),r.error?b(r.error):(s(x?{type:"UPDATE_APPOINTMENT",payload:r.data}:{type:"ADD_APPOINTMENT",payload:r.data}),p(!1))},B=n=>{const r=new Date(n),u=new Date,$=new Date(u);$.setDate($.getDate()+1);const J=r.toISOString().split("T")[0],se=u.toISOString().split("T")[0],te=$.toISOString().split("T")[0];return J===se?"Today":J===te?"Tomorrow":r.toLocaleDateString("en-GB",{weekday:"long",year:"numeric",month:"long",day:"numeric"})},z=n=>c==="admin"||c==="employee"&&n.employee_id===A,ee=c==="employee";return d?e.jsxs(e.Fragment,{children:[e.jsxs(H,{className:"mb-4",children:[e.jsxs(ye,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:"Schedule"}),e.jsxs("pre",{children:["loading : ",JSON.stringify(_)]}),e.jsxs(k,{color:"primary",onClick:f,children:[e.jsx(O,{icon:de,className:"me-2"}),"New Appointment"]})]}),e.jsxs(Z,{children:[o&&e.jsx(R,{color:"danger",className:"mb-3",children:o}),_?e.jsx("div",{className:"text-center py-5",children:e.jsx(G,{color:"primary"})}):Object.keys(S).length===0?e.jsx("div",{className:"text-center py-5 text-muted",children:"No upcoming appointments. Create your first appointment to get started."}):e.jsx("div",{children:Object.keys(S).sort().map(n=>e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2 mb-3",children:[e.jsx("h5",{className:"mb-0",children:B(n)}),e.jsxs(W,{color:"primary",className:"ms-2",children:[S[n].length," appointment",S[n].length!==1?"s":""]})]}),S[n].map(r=>e.jsx(X,{appointment:r,onClick:()=>z(r)&&E(r),hideClientPII:ee},r.id))]},n))})]})]}),e.jsxs(me,{visible:i,onClose:()=>p(!1),size:"lg",children:[e.jsx(ue,{children:e.jsx(pe,{children:x?"Edit Appointment":"New Appointment"})}),e.jsx(he,{children:e.jsx(Y,{appointment:x,onSubmit:I,onCancel:()=>p(!1),loading:L,error:N})})]})]}):e.jsx(H,{children:e.jsx(Z,{children:e.jsx(R,{color:"warning",children:"No business found. Please ensure you are logged in with a business account."})})})};export{De as default};
